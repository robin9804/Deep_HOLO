import tensorflow as tf
from tensorflow.keras import Input

# import data


def conv2d(inputs, filters):
    x = tf.keras.layers.Conv2D(filters, 3, activation='relu', padding='same')(inputs)
    x = tf.keras.layers.Conv2D(filters, 3, activation='relu', padding='same')(x)
    x1 = tf.keras.layers.BatchNormalization()(x)
    x = tf.keras.layers.Conv2D(filters, 3, activation='relu', padding='same')(x1)
    x = tf.keras.layers.Conv2D(filters, 3, activation='relu', padding='same')(x)
    return x + x1


# input 정해주기
input_tensor = Input(shape=(224,224,3), dtype='float32', name='input')
x = tf.keras.layers.Conv2D(filters=64, kernel_size=7, strides=2, activation='relu')(input_tensor)
x = tf.keras.layers.MaxPooling2D((3,3), strides=2, padding='same')(x)
x = conv2d(x, 64)
x = conv2d(x, 128)
x = conv2d(x, 256)
x = conv2d(x, 512)
#x = tf.keras.layers.Flatten()(x)  얘가 차원을 줄여벌였다.
x = tf.keras.layers.GlobalAveragePooling2D()(x)
res34 = tf.keras.layers.Dense(1000, activation='softmax')(x)

model = tf.keras.Model(input_tensor, res34)
model.summary()

"""
결과
Model: "model"
__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to                     
==================================================================================================
input (InputLayer)              [(None, 224, 224, 3) 0                                            
__________________________________________________________________________________________________
conv2d (Conv2D)                 (None, 109, 109, 64) 9472        input[0][0]                      
__________________________________________________________________________________________________
max_pooling2d (MaxPooling2D)    (None, 55, 55, 64)   0           conv2d[0][0]                     
__________________________________________________________________________________________________
conv2d_1 (Conv2D)               (None, 55, 55, 64)   36928       max_pooling2d[0][0]              
__________________________________________________________________________________________________
conv2d_2 (Conv2D)               (None, 55, 55, 64)   36928       conv2d_1[0][0]                   
__________________________________________________________________________________________________
batch_normalization (BatchNorma (None, 55, 55, 64)   256         conv2d_2[0][0]                   
__________________________________________________________________________________________________
conv2d_3 (Conv2D)               (None, 55, 55, 64)   36928       batch_normalization[0][0]        
__________________________________________________________________________________________________
conv2d_4 (Conv2D)               (None, 55, 55, 64)   36928       conv2d_3[0][0]                   
__________________________________________________________________________________________________
tf_op_layer_add (TensorFlowOpLa [(None, 55, 55, 64)] 0           conv2d_4[0][0]                   
                                                                 batch_normalization[0][0]        
__________________________________________________________________________________________________
conv2d_5 (Conv2D)               (None, 55, 55, 128)  73856       tf_op_layer_add[0][0]            
__________________________________________________________________________________________________
conv2d_6 (Conv2D)               (None, 55, 55, 128)  147584      conv2d_5[0][0]                   
__________________________________________________________________________________________________
batch_normalization_1 (BatchNor (None, 55, 55, 128)  512         conv2d_6[0][0]                   
__________________________________________________________________________________________________
conv2d_7 (Conv2D)               (None, 55, 55, 128)  147584      batch_normalization_1[0][0]      
__________________________________________________________________________________________________
conv2d_8 (Conv2D)               (None, 55, 55, 128)  147584      conv2d_7[0][0]                   
__________________________________________________________________________________________________
tf_op_layer_add_1 (TensorFlowOp [(None, 55, 55, 128) 0           conv2d_8[0][0]                   
                                                                 batch_normalization_1[0][0]      
__________________________________________________________________________________________________
conv2d_9 (Conv2D)               (None, 55, 55, 256)  295168      tf_op_layer_add_1[0][0]          
__________________________________________________________________________________________________
conv2d_10 (Conv2D)              (None, 55, 55, 256)  590080      conv2d_9[0][0]                   
__________________________________________________________________________________________________
batch_normalization_2 (BatchNor (None, 55, 55, 256)  1024        conv2d_10[0][0]                  
__________________________________________________________________________________________________
conv2d_11 (Conv2D)              (None, 55, 55, 256)  590080      batch_normalization_2[0][0]      
__________________________________________________________________________________________________
conv2d_12 (Conv2D)              (None, 55, 55, 256)  590080      conv2d_11[0][0]                  
__________________________________________________________________________________________________
tf_op_layer_add_2 (TensorFlowOp [(None, 55, 55, 256) 0           conv2d_12[0][0]                  
                                                                 batch_normalization_2[0][0]      
__________________________________________________________________________________________________
conv2d_13 (Conv2D)              (None, 55, 55, 512)  1180160     tf_op_layer_add_2[0][0]          
__________________________________________________________________________________________________
conv2d_14 (Conv2D)              (None, 55, 55, 512)  2359808     conv2d_13[0][0]                  
__________________________________________________________________________________________________
batch_normalization_3 (BatchNor (None, 55, 55, 512)  2048        conv2d_14[0][0]                  
__________________________________________________________________________________________________
conv2d_15 (Conv2D)              (None, 55, 55, 512)  2359808     batch_normalization_3[0][0]      
__________________________________________________________________________________________________
conv2d_16 (Conv2D)              (None, 55, 55, 512)  2359808     conv2d_15[0][0]                  
__________________________________________________________________________________________________
tf_op_layer_add_3 (TensorFlowOp [(None, 55, 55, 512) 0           conv2d_16[0][0]                  
                                                                 batch_normalization_3[0][0]      
__________________________________________________________________________________________________
global_average_pooling2d (Globa (None, 512)          0           tf_op_layer_add_3[0][0]          
__________________________________________________________________________________________________
dense (Dense)                   (None, 1000)         513000      global_average_pooling2d[0][0]   
==================================================================================================
Total params: 11,515,624
Trainable params: 11,513,704
Non-trainable params: 1,920
__________________________________________________________________________________________________
"""
